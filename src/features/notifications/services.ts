import { PushNotification } from './types';
import firebase from 'firebase-admin';
import { QueryHandle } from '../../types/general';

import { modelGetter } from './schemas';
import { getAllFilterQuery, GetAllNotificationsArgs, getNotificationsCredentials } from './utils';

import { ModelCrudTemplate } from '../../utils/ModelCrudTemplate';

export class NotificationsServices extends ModelCrudTemplate<
  PushNotification,
  Pick<
    PushNotification,
    | 'type'
    | 'userIds'
    | 'readBys'
    | 'postId'
    | 'shoppingId'
    | 'shoppingCode'
    | 'stockAmountAvailable'
    | 'routeName'
    | 'businessName'
    | 'meta'
    | 'paymentProofCode'
    | 'paymentProofId'
    | 'message'
  >,
  GetAllNotificationsArgs
> {
  constructor() {
    super(modelGetter, getAllFilterQuery);
    this.notificationsServicesInit();
  }

  private firebaseInstance = firebase;

  private notificationsServicesInit = () => {
    firebase.initializeApp({
      //@ts-expect-error ignore
      credential: firebase.credential.cert(getNotificationsCredentials())
    });
    console.info('Initialized Firebase SDK');
  };

  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

  sendEachForMulticast: QueryHandle<{
    notification: PushNotification;
    tokens: Array<string>;
    body?: string;
    title?: string;
  }> = async ({ notification, tokens, body, title }) => {
    await this.firebaseInstance.messaging().sendEachForMulticast({
      data: { payload: JSON.stringify(notification) },
      tokens,
      notification: {
        title,
        body
      }
    });
  };
}
